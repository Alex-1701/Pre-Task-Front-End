<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <title>Регистрация</title>
</head>

<body>

    <!-- Кнопка смены цветовой темы -->
    <div id="dark_theme_box">
        <button id="dark_theme_button" onclick="swap_theme()" class="toggle_theme_button" tabindex="99"></button>
    </div>


    <div id="main_form_box">
        <!-- Форма по клику вызывает функцию send_data() -->
        <form id="main_form" onsubmit="return send_data(event)">
            <!-- Поле ввода имени -->
            <div class="form_input">
                <label for="input_name">Введите имя</label>
                <input type="text" name="name" id="input_name" class="text_input" placeholder="user_name" minlength="3"
                    maxlength="50" title="Придумайте имя под которым вы будете входть в систему" required tabindex="1">
            </div>

            <!-- Поле ввода пароля -->
            <div class="form_input">
                <label for="input_password">Введите пароль</label>
                <input type="password" name="password" id="input_password" class="text_input"
                    placeholder="user_password" minlength="5" maxlength="50"
                    title="Придумайте уникальный пароль который вы будете использовать для входа в систему" tabindex="2"
                    required>
            </div>

            <!-- Поле проверки пароля -->
            <div class="form_input">
                <label for="input_password_repeat">Повторите пароль</label>
                <input type="password" name="password" id="input_password_repeat" class="text_input"
                    placeholder="user_password" minlength="5" maxlength="50" title="Повторите свой пароль" tabindex="3"
                    required>
            </div>

            <!-- Поле ввода почты -->
            <div class="form_input">
                <label for="input_email">Введите email</label>
                <input type="email" name="email" id="input_email" class="text_input" placeholder="user_name@example.com"
                    title="Введите адрес электронноы почты который будет использован для верификации вашего аккаунта"
                    required tabindex="4">
            </div>

            <!-- Кнопка отправки формы на сервер -->
            <div class="form_input" id="submit_button_box">
                <button id="submit_button" type="submit" tabindex="5">Зарегестрироваться</button>
            </div>

        </form>
    </div>
    <script>
        "use strict"

        check_theme();

        function send_data(event) {
            event.preventDefault();

            let user_name = document.getElementById("input_name").value;
            let user_password = document.getElementById("input_password").value;
            let user_password_repeat = document.getElementById("input_password_repeat").value;
            let user_email = document.getElementById("input_email").value;

            // Проверка на совпадения введённых паролей.
            if (user_password != user_password_repeat) {
                alert("Ошибка клиента: пароли должны совпадать!");
            } else {
                let user_data = {
                    name: user_name,
                    password: user_password,
                    email: user_email
                }

                //console.log(user_data);
                //console.log(JSON.stringify(user_data));

                // Обращение на сервер с которого была загружена страница. К обработчику register
                // Отлажено для собственного сервера запущенного на localhost
                fetch("/register", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json;charset=utf-8'
                    },
                    // отправляем объект упакованный в JSON
                    body: JSON.stringify(user_data)
                })
                    .then((response) => {
                        return response.json();
                    })
                    .then((data) => {
                        //console.log(data);
                        // Анализ ответа сервера.
                        // При успешной обработки данных редирект на страницу с сообщением об успехе.
                        // Иначе сообщение об ошибке
                        if (data.status == "success") {
                            window.location.href = "./success.html";

                        }
                        else {
                            alert("Ошибка сервера!");
                        }
                    })
                    .catch(e => {
                        // Перехват ошибки. Если страница открыта с локального диска срабатывает всегда.
                        alert("Ошибка сервера: сервер недоступен.")
                    })
            }

            //return false;
        }

        // Сменяет цветовую схему на проивоположную.
        function swap_theme() {
            if (localStorage.getItem("color-theme") == "dark") {
                // Если была тёмная, стваим светлую.
                localStorage.setItem("color-theme", "light");
                document.body.classList.remove('dark-theme');
                document.getElementById("dark_theme_button").innerText = "Тёмная тема";
            } else {
                // Если была светлая, стваим тёмную.
                localStorage.setItem("color-theme", "dark");
                document.body.classList.toggle('dark-theme');
                document.getElementById("dark_theme_button").innerText = "Светлая тема";
            }
        }

        // Для сохранения темы после обновления страницы.
        function check_theme() {
            // Если цвет ещё не переключали. То ставим светлую тему.
            if (localStorage.getItem("color-theme") === null) {
                // Добавляем переменную.
                localStorage.setItem("color-theme", "light");
                // Переимпеновываем кнопку.
                document.getElementById("dark_theme_button").innerText = "Тёмная тема";
            } else {
                if (localStorage.getItem("color-theme") == "dark") {
                    // Если стояла тёмная, ставим тёмную.
                    localStorage.setItem("color-theme", "dark");
                    document.body.classList.add('dark-theme');
                    document.getElementById("dark_theme_button").innerText = "Светлая тема";
                }
                else {
                    // Если стояла светлая, ставим светлую.
                    localStorage.setItem("color-theme", "light");
                    document.getElementById("dark_theme_button").innerText = "Тёмная тема";
                }
            }
        }
    </script>
</body>

</html>